<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.0 on Fri Jan 16 23:50:53 2009 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>ajs_lf_plot.pro (Anthony Smith's IDL routines)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="ajs_lf_plot.pro (Anthony Smith's IDL routines)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;+</span>
<span class="comments">; This procedure produces a plot of the luminosity function.</span>
<span class="comments">;-</span>

<span class="comments">;+</span>
<span class="comments">; Choose and set xrange</span>
<span class="comments">;-</span>
FUNCTION ajs_lf_plot_xrange, bincentres=bincentres, loglum=loglum, $
                             schechter=schechter, $
                             double_schechter=double_schechter
  compile_opt idl2, hidden

  <span class="comments">;; M-star?</span>
  IF n_elements(schechter) GT 1 THEN $
     mstar = schechter[0] $
  ELSE IF n_elements(double_schechter) GT 1 THEN $
     mstar = double_schechter[0]

  <span class="comments">;; Set xrange limits</span>
  IF n_elements(bincentres) GT 0 THEN BEGIN
      <span class="comments">;; ... from data points</span>
      binwidth = (max(bincentres) - min(bincentres)) $
                 / (n_elements(bincentres) - 1)
      IF keyword_set(loglum) THEN $
         xrange = [min(bincentres) - binwidth / 2., $
                   max(bincentres) + binwidth / 2.] $
      ELSE $
         xrange = [max(bincentres) + binwidth / 2., $
                   min(bincentres) - binwidth / 2.]
  ENDIF ELSE IF n_elements(mstar) GT 0 THEN BEGIN
      <span class="comments">;; ... or from Schechter function</span>
      IF keyword_set(loglum) THEN $
         xrange = [mstar - 6, $
                   mstar + 4] $
      ELSE $
         xrange = [mstar + 6, $
                   mstar - 4]
  ENDIF

  return, xrange
END


<span class="comments">;+</span>
<span class="comments">; Choose and set yrange</span>
<span class="comments">;-</span>
FUNCTION ajs_lf_plot_yrange, phi=phi, input_logphi=input_logphi, $
                             plot_logphi=plot_logphi, schechter=schechter, $
                             double_schechter=double_schechter
  compile_opt idl2, hidden

  <span class="comments">;; Phi-star?</span>
  IF n_elements(schechter) GT 1 THEN $
     phistar = schechter[2] $
  ELSE IF n_elements(double_schechter) GT 1 THEN $
     phistar = double_schechter[2] > double_schechter[4]
  
  <span class="comments">;; Set yrange limits</span>
  IF n_elements(phi) GT 0 THEN BEGIN
      <span class="comments">;; ... from data points</span>
      IF keyword_set(input_logphi) THEN $
         yrange = 10. ^ [min(phi[where(finite(phi))]) - 10, $
                         max(phi[where(finite(phi))]) + 2] $
      ELSE $
         yrange = [min(phi[where(finite(phi))]) / 10, $
                   max(phi[where(finite(phi))]) * 2]
  ENDIF ELSE BEGIN
      <span class="comments">;; ... or from Schechter function</span>
      IF keyword_set(input_logphi) THEN $ 
         yrange = 10. ^ [phistar - 4, phistar + 2] $
      ELSE $
         yrange = [phistar / 1e4, phistar * 1e2]
  ENDELSE

  <span class="comments">;; Y-axis log(phi) rather than phi?</span>
  IF keyword_set(plot_logphi) THEN $
     yrange = alog10(yrange)

  return, yrange
END


<span class="comments">;+</span>
<span class="comments">; Add legend text to the plot</span>
<span class="comments">;-</span>
PRO ajs_lf_plot_legend, legend_text=legend_text, legend_pos=legend_pos, $
                        arg_legend_pos=arg_legend_pos, $
<span class="comments">;;                         xrange=xrange, yrange=yrange, loglum=loglum, $</span>
<span class="comments">;;                         plot_logphi=plot_logphi, $</span>
                        schechter=schechter, $
                        double_schechter=double_schechter, $
                        color=color, psym=psym, _REF_EXTRA=e
  compile_opt idl2, hidden
  debug = ajs_debug()

  <span class="comments">;; Create legend text?</span>
  IF n_elements(legend_text) GT 0 THEN BEGIN 
      IF n_elements(legend_pos) LE 1 THEN BEGIN
          <span class="comments">;; Position for legend item</span>
<span class="comments">;;           IF n_elements(xrange) LE 1 OR n_elements(yrange) LE 1 THEN BEGIN</span>
<span class="comments">;;               message, 'Cannot position legend text: supply xrange and yrange'</span>
<span class="comments">;;           ENDIF ELSE BEGIN</span>
<span class="comments">;;               xpos = (xrange[1] - xrange[0]) / 10. + xrange[0]</span>
<span class="comments">;;               IF keyword_set(plot_logphi) THEN $</span>
<span class="comments">;;                  ypos = (yrange[1] - yrange[0]) / 10. + yrange[0] $</span>
<span class="comments">;;               ELSE $</span>
<span class="comments">;;                  ypos = (yrange[1] / yrange[0]) ^ 0.1 * yrange[0]</span>
<span class="comments">;;           ENDELSE</span>
          xpos = 0.1
          ypos = 0.1
      ENDIF ELSE BEGIN
          xpos = legend_pos[0]
          ypos = legend_pos[1]
      ENDELSE 
          
      <span class="comments">;; Symbol/line (to left on plot = + if x-axis reversed)</span>
<span class="comments">;;       xpos_sym = xpos + 0.12 * (!x.crange[1] GT !x.crange[0] ? -1 : 1)</span>
<span class="comments">;;       xpos_line = [xpos + 0.21 * (!x.crange[1] GT !x.crange[0] ? -1 : 1), $</span>
<span class="comments">;;                    xpos + 0.03 * (!x.crange[1] GT !x.crange[0] ? -1 : 1)]</span>
<span class="comments">;;       IF keyword_set(plot_logphi) THEN $</span>
<span class="comments">;;          ypos_sym = ypos + 0.05 $</span>
<span class="comments">;;       ELSE $</span>
<span class="comments">;;          ypos_sym = ypos * 1.15</span>
<span class="comments">;;       IF n_elements(psym) GT 0 THEN $</span>
<span class="comments">;;          oplot, [xpos_sym], [ypos_sym], psym=psym, color=color</span>
<span class="comments">;;       IF n_elements(schechter) GT 1 OR n_elements(double_schechter) GT 1 $</span>
<span class="comments">;;          OR psym LE 0 THEN $</span>
<span class="comments">;;          oplot, xpos_line, [ypos_sym, ypos_sym], $</span>
<span class="comments">;;                 color=color, _STRICT_EXTRA=e</span>

<span class="comments">;;       xpos_sym = ajs_plot_pos(xpos - 0.05)</span>
<span class="comments">;;       xpos_line = ajs_plot_pos([xpos - 0.08, xpos - 0.02])</span>
<span class="comments">;;       ypos_sym = ajs_plot_pos(y_in=ypos + 0.01)</span>
      IF n_elements(psym) GT 0 THEN $
         oplot, [ajs_plot_pos(xpos - 0.04)], $
                [ajs_plot_pos(y_in=ypos + 0.01)], psym=psym, color=color
      IF n_elements(schechter) GT 1 OR n_elements(double_schechter) GT 1 $
         OR psym LE 0 THEN $
            oplot, ajs_plot_pos([xpos - 0.06, xpos - 0.02]), $
                   ajs_plot_pos(y_in=[ypos + 0.01, ypos + 0.01]), $
                   color=color, _STRICT_EXTRA=e
      
      <span class="comments">;; Text</span>
      IF debug GE 2 THEN $
         message, 'xpos, ypos = ' + string(xpos) + string(ypos), /inf
<span class="comments">;;       xyouts, xpos, ypos, legend_text, color=color</span>
      xyouts, ajs_plot_pos(xpos), ajs_plot_pos(y_in=ypos), legend_text, $
              color=color
      
      <span class="comments">;; Position for next legend item</span>
      IF arg_legend_pos THEN BEGIN
<span class="comments">;;          IF n_elements(yrange) GT 1 THEN BEGIN</span>
<span class="comments">;;               IF keyword_set(plot_logphi) THEN BEGIN </span>
<span class="comments">;;                   ydelta = (yrange[1] - yrange[0]) / 20.</span>
<span class="comments">;;                   ypos = ypos + ydelta              </span>
<span class="comments">;;               ENDIF ELSE BEGIN</span>
<span class="comments">;;                   ydelta = (yrange[1] / yrange[0]) ^ (1. / 20)</span>
<span class="comments">;;                   ypos = ypos * ydelta</span>
<span class="comments">;;               ENDELSE</span>
<span class="comments">;;               legend_pos = [xpos, ypos]</span>
          legend_pos = [xpos, ypos + 0.05]
<span class="comments">;;           ENDIF ELSE BEGIN</span>
<span class="comments">;;               message, 'Supply yrange for new legend_pos values', /inf</span>
<span class="comments">;;               legend_pos = 0</span>
<span class="comments">;;           ENDELSE</span>
      ENDIF ELSE BEGIN
          message, 'Supply variable name for legend_pos for new values', /inf
      ENDELSE          
  ENDIF
END


<span class="comments">;+</span>
<span class="comments">; This procedure produces a plot of the luminosity function.</span>
<span class="comments">;</span>
<span class="comments">; Data may be entered in four forms:</span>
<span class="comments">;</span>
<span class="comments">; (1) Values at particular absolute magnitudes (bincentres, phi[, err_phi])</span>
<span class="comments">;</span>
<span class="comments">; (2) (double) Schechter function parameters (always plotted if supplied)</span>
<span class="comments">;</span>
<span class="comments">; (3) Array of galaxy absolute magnitudes and weights (e.g., 1/Vmax) -</span>
<span class="comments">; ignored if (1) set</span>
<span class="comments">;</span>
<span class="comments">; (4) From a file, to be read using ajs_lf_read - ignored if (1) or (3) set</span>
<span class="comments">;</span>
<span class="comments">; In addition, a (double) Schechter function fit can be performed.</span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;    bincentres : in, optional</span>
<span class="comments">;    phi : in, optional</span>
<span class="comments">;    err_phi : in, optional</span>
<span class="comments">;    neg_err_phi : in, optional</span>
<span class="comments">;       Negative error, for asymmetric</span>
<span class="comments">;    pos_err_phi : in, optional</span>
<span class="comments">;       Positive error, for asymmetric</span>
<span class="comments">;    lower_limit_where : in, optional</span>
<span class="comments">;       Indices of values of phi where the upper error bar is a lower</span>
<span class="comments">;       limit (i.e., plot arrowhead and empty circle, if psym=16 set)</span>
<span class="comments">;    schechter : in, optional</span>
<span class="comments">;       Plot Schechter function. Set to undefined variable to</span>
<span class="comments">;       calculate best-fitting Schechter function and return the</span>
<span class="comments">;       parameters. Or set /schechter to calculate and print the</span>
<span class="comments">;       parameters</span>
<span class="comments">;    sch_range : in, optional</span>
<span class="comments">;       Range of absolute magnitudes for (double) Schechter fit</span>
<span class="comments">;       (ajs_schechter_fit)</span>
<span class="comments">;    cov_mat : out, optional</span>
<span class="comments">;       Covariance matrix of Schechter function fit</span>
<span class="comments">;    double_schechter: in, out, optional</span>
<span class="comments">;       Plot double Schechter function. Set to undefined variable to</span>
<span class="comments">;       calculate best-fitting double Schechter function and return the</span>
<span class="comments">;       parameters. Or set /double_schechter to calculate and print the</span>
<span class="comments">;       parameters</span>
<span class="comments">;    double_cov_mat : out, optional</span>
<span class="comments">;       Covariance matrix of double Schechter function fit</span>
<span class="comments">;    abs_mag : in, optional</span>
<span class="comments">;       Array of absolute magnitudes (use with weights)</span>
<span class="comments">;    weights : in, optional</span>
<span class="comments">;       Array of weights (e.g., 1/Vmax) for estimating luminosity</span>
<span class="comments">;       function</span>
<span class="comments">;    jackknife : in, optional</span>
<span class="comments">;       Used with absmag, this is an integer for each galaxy</span>
<span class="comments">;       giving the jackknife region in which the galaxy lies</span>
<span class="comments">;    nbins : in, optional</span>
<span class="comments">;       Number of bins for abs_mag & weights (use with xrange or bincentres)</span>
<span class="comments">;    datfile : in, optional</span>
<span class="comments">;       Input data: binary format file created by ajs_lf_write</span>
<span class="comments">;    overplot : in, optional</span>
<span class="comments">;       Set /overplot to overplot</span>
<span class="comments">;    plotfile : in, optional</span>
<span class="comments">;       EPS file name</span>
<span class="comments">;    show_plot : in, optional</span>
<span class="comments">;       Set /show_plot to open the EPS file for viewing</span>
<span class="comments">;    open : in, optional</span>
<span class="comments">;       Set /open to open the EPS file and leave it for overplotting</span>
<span class="comments">;    close : in, optional</span>
<span class="comments">;       Set /close to close the EPS plotfile</span>
<span class="comments">;    xrange : in, out, optional</span>
<span class="comments">;    yrange : in, out, optional</span>
<span class="comments">;    input_logphi : in, optional</span>
<span class="comments">;       Set /input_logphi to indicate data values are log(phi) rather</span>
<span class="comments">;       than phi</span>
<span class="comments">;    plot_logphi : in, optional</span>
<span class="comments">;       Set /plot_logphi to plot log(phi) rather than phi (redundant</span>
<span class="comments">;       if overplotting)</span>
<span class="comments">;    loglum : in, optional</span>
<span class="comments">;       Set /loglum for log luminosities rather than magnitudes</span>
<span class="comments">;    ylog : in, optional, default=1-plot_logphi</span>
<span class="comments">;    psym : in, optional</span>
<span class="comments">;       Uses D. Fanning's symcat (e.g., 16 = filled circle) for</span>
<span class="comments">;       non-standard psym values</span>
<span class="comments">;    symcat_thick : in, optional</span>
<span class="comments">;       Thick keyword for symcat</span>
<span class="comments">;    band_name : in, optional</span>
<span class="comments">;       For the x-axis: M_&lt;band_name> - 5 log h</span>
<span class="comments">;    color : in, optional</span>
<span class="comments">;    xstyle : in, optional</span>
<span class="comments">;       Default /xstyle</span>
<span class="comments">;    ystyle : in, optional</span>
<span class="comments">;       Default /ystyle</span>
<span class="comments">;    title : in, optional</span>
<span class="comments">;       Title for plot</span>
<span class="comments">;    xtitle : in, optional</span>
<span class="comments">;       Title for x-axis</span>
<span class="comments">;    ytitle : in, optional</span>
<span class="comments">;       Title for y-axis</span>
<span class="comments">;    legend_pos : in, out, optional, type=fltarr(2)</span>
<span class="comments">;       [xpos, ypos] for legend text. Output is position for next</span>
<span class="comments">;       legend label, for overplotting. varies from [0, 0] = [left,</span>
<span class="comments">;       bottom] to [1, 1] = [right, top].</span>
<span class="comments">;    legend_text : in, optional</span>
<span class="comments">;       Legend text</span>
<span class="comments">;    _REF_EXTRA : in, optional</span>
<span class="comments">;       Extra keywords for plots</span>
<span class="comments">;</span>
<span class="comments">; :Examples:</span>
<span class="comments">;    bincentres = [-20, -22, -24]</span>
<span class="comments">;</span>
<span class="comments">;    phi = [1e-2, 1e-2, 1e-3]</span>
<span class="comments">;</span>
<span class="comments">;    err_phi = [1e-2, 1e-3, 1e-4]</span>
<span class="comments">;</span>
<span class="comments">;    ajs_lf_plot, bincentres=bincentres, phi=phi</span>
<span class="comments">;</span>
<span class="comments">;    ajs_lf_plot, bincentres=bincentres, phi=phi, err_phi=err_phi</span>
<span class="comments">;</span>
<span class="comments">;    ajs_lf_plot, bincentres=bincentres, phi=phi, err_phi=err_phi, psym=16</span>
<span class="comments">;</span>
<span class="comments">;    ajs_lf_plot, schechter=[-24,-1,1e-2]</span>
<span class="comments">;</span>
<span class="comments">;    ajs_lf_plot, schechter=[-24,-1,1e-2], color=2, bincentres=bincentres, phi=phi, err_phi=err_phi, xrange=[-16,-26], psym=16, plotfile='~/lf.eps', /show_plot</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;    13 Feb 2008 Created, Anthony Smith</span>
<span class="comments">;</span>
<span class="comments">;    5 Mar 2008 err_phi no longer required</span>
<span class="comments">;</span>
<span class="comments">;    6 Mar 2008 Added abs_mag, weights and nbins</span>
<span class="comments">;</span>
<span class="comments">;    18 Mar 2008 Added jackknife</span>
<span class="comments">;</span>
<span class="comments">;    25 Mar 2008 Added legend_text and legend_pos</span>
<span class="comments">;</span>
<span class="comments">;    4 Apr 2008 Added sch_range (ajs_schechter_fit range)</span>
<span class="comments">;</span>
<span class="comments">;    7 Apr 2008 Schechter function info included in call to ajs_vmax_lf</span>
<span class="comments">;</span>
<span class="comments">;    21 Apr 2008 double Schechter function input</span>
<span class="comments">;</span>
<span class="comments">;    23 Apr 2008 psym now uses D. Fanning's symcat routine;</span>
<span class="comments">;    added lower_limit_where keyword</span>
<span class="comments">;</span>
<span class="comments">;    1 May 2008 Uses ajs_plot_pos for legend position</span>
<span class="comments">;-</span>
PRO ajs_lf_plot, bincentres=bincentres, $
                 phi=phi, $
                 err_phi=err_phi, $
                 neg_err_phi=neg_err_phi, $
                 pos_err_phi=pos_err_phi, $
                 lower_limit_where=lower_limit_where, $
                 schechter=schechter, $
                 sch_range=sch_range, $
                 double_schechter=double_schechter, $
                 double_cov_mat=double_cov_mat, $
                 abs_mag=abs_mag, $
                 weights=weights, $
                 jackknife=jackknife, $
                 nbins=nbins, $
                 datfile=datfile, $
                 overplot=overplot, $
                 plotfile=plotfile, $
                 show_plot=show_plot, $
                 open=open, $
                 close=close, $
                 xrange=xrange, $
                 yrange=yrange, $
                 input_logphi=input_logphi, $
                 plot_logphi=plot_logphi, $
                 loglum=loglum, $
                 ylog=ylog, $
                 psym=psym, $
                 symcat_thick=symcat_thick, $
                 band_name=band_name, $
                 color=color, $
                 xstyle=xstyle, $
                 ystyle=ystyle, $
                 title=title, $
                 xtitle=xtitle, $
                 ytitle=ytitle, $
                 legend_pos=legend_pos, $
                 legend_text=legend_text, $
                 cov_mat=cov_mat, $
                 _REF_EXTRA=e

  compile_opt idl2
  debug = ajs_debug()
  IF debug GE 1 THEN BEGIN 
      message, 'Plotting LF', /inf
      message, ajs_kw_string(overplot=overplot, schechter=schechter, $
                             plotfile=plotfile, show_plot=show_plot, $
                             open=open, close=close, $
                             double_schechter=double_schechter), /inf
  ENDIF 

  <span class="comments">;; Keywords</span>
  <span class="comments">;; Won't go wrong if symcat not available</span>
  IF n_elements(psym) GT 0 THEN BEGIN
      IF abs(psym) EQ 9 OR abs(psym) GT 10 THEN $
         psym_use = symcat(abs(psym), thick=symcat_thick) $
      ELSE $
         psym_use = psym
      psym_use = abs(psym_use) * (psym GT 0 ? 1 : -1)
  ENDIF ELSE $
     psym_use = 0
     
  <span class="comments">;; Plot something?</span>
  IF NOT keyword_set(close) THEN BEGIN
      <span class="comments">;; Any data to plot?</span>
      IF n_elements(datfile) EQ 0 AND n_elements(phi) EQ 0 $
         AND NOT keyword_set(open) EQ 0 $
         AND n_elements(schechter) LE 1 $
         AND n_elements(double_schechter) LE 1 $ 
         AND n_elements(absmag) EQ 0 THEN $
            message, 'No data!'

      <span class="comments">;; Setup plot</span>
      eps = keyword_set(open) OR keyword_set(show_plot)
      ajs_plot_start, plotfile=plotfile, eps=eps

      <span class="comments">;; Choose source of phi data: (1) phi, (2) absmag or (3) datfile</span>
      IF n_elements(phi) EQ 0 THEN BEGIN
          IF n_elements(abs_mag) GT 0 THEN BEGIN
              <span class="comments">;; Data from absolute magnitudes & weights</span>
              <span class="comments">;; Calculate luminosity function</span>
              IF debug GE 1 THEN message, 'Calculating from absmags', /inf
              <span class="comments">;; Include Schechter fit?</span>
              IF (n_elements(schechter) LE 1 $
                  AND (arg_present(schechter) $
                       OR keyword_set(schechter))) THEN BEGIN
                  IF (n_elements(double_schechter) LE 1 $
                      AND (arg_present(double_schechter) $
                           OR keyword_set(double_schechter))) THEN BEGIN
                      IF debug GE 2 THEN message, $
                         '1/Vmax with Schechter and double Schechter', /inf
                      phi = ajs_vmax_lf(abs_mag, weights, $
                                        bincentres=bincentres, $
                                        err_phi=err_phi, nbins=nbins, $
                                        xrange=xrange, $
                                        jackknife=jackknife, $
                                        schechter=schechter, $
                                        cov_mat=cov_mat, sch_range=sch_range, $
                                        double_schechter=double_schechter, $
                                        double_cov_mat=double_cov_mat, $
                                        loglum=loglum)
                  ENDIF ELSE BEGIN
                      IF debug GE 2 THEN message, $
                         '1/Vmax with Schechter', /inf
                      phi = ajs_vmax_lf(abs_mag, weights, $
                                        bincentres=bincentres, $
                                        err_phi=err_phi, nbins=nbins, $
                                        xrange=xrange, $
                                        jackknife=jackknife, $
                                        schechter=schechter, $
                                        cov_mat=cov_mat, sch_range=sch_range, $
                                        loglum=loglum)
                  ENDELSE
              ENDIF ELSE BEGIN
                  IF (n_elements(double_schechter) LE 1 $
                      AND (arg_present(double_schechter) $
                           OR keyword_set(double_schechter))) THEN BEGIN
                      IF debug GE 2 THEN message, $
                         '1/Vmax with double Schechter', /inf
                      phi = ajs_vmax_lf(abs_mag, weights, $
                                        bincentres=bincentres, $
                                        err_phi=err_phi, nbins=nbins, $
                                        xrange=xrange, $
                                        jackknife=jackknife, $
                                        sch_range=sch_range, $
                                        double_schechter=double_schechter, $
                                        double_cov_mat=double_cov_mat, $
                                        loglum=loglum)
                  ENDIF ELSE BEGIN
                      IF debug GE 2 THEN message, '1/Vmax (no Schechter)', /inf
                      phi = ajs_vmax_lf(abs_mag, weights, $
                                        bincentres=bincentres, $
                                        err_phi=err_phi, nbins=nbins, $
                                        xrange=xrange, $
                                        jackknife=jackknife, $
                                        loglum=loglum)
                  ENDELSE
              ENDELSE 
          ENDIF ELSE IF n_elements(datfile) GT 0 THEN BEGIN
              <span class="comments">;; Data from file</span>
              IF debug GE 1 THEN message, 'Reading data from file', /inf
              ajs_lf_read, datfile, bincentres, phi, err_phi
          ENDIF
      ENDIF ELSE $
         IF debug GE 1 THEN message, 'Using supplied values of phi', /inf

      <span class="comments">;; Create axes (if not overplot)</span>
      IF NOT keyword_set(overplot) THEN BEGIN
          <span class="comments">;; Titles not set</span>
          IF n_elements(ytitle) EQ 0 THEN BEGIN
              IF keyword_set(loglum) THEN BEGIN
                  IF keyword_set(plot_logphi) THEN $
                     ytitle = 'log (!4U!3 / (h!U3!N Mpc!U-3!N dex!U-1!N) )' $
                  ELSE $
                     ytitle = '!4U!3 / (h!U3!N Mpc!U-3!N dex!U-1!N)'
              ENDIF ELSE BEGIN
                  IF keyword_set(plot_logphi) THEN $
                     ytitle = 'log (!4U!3 / (h!U3!N Mpc!U-3!N mag!U-1!N) )' $
                  ELSE $
                     ytitle = '!4U!3 / (h!U3!N Mpc!U-3!N mag!U-1!N)'
              ENDELSE
          ENDIF
          IF n_elements(xtitle) EQ 0 THEN BEGIN
              IF keyword_set(loglum) THEN BEGIN
                  IF n_elements(band_name) GT 0 THEN $
                     xtitle = 'log L!D' + band_name + '!N' $
                  ELSE $
                     xtitle = 'log L'
              ENDIF ELSE BEGIN
                  IF n_elements(band_name) GT 0 THEN $
                     xtitle = 'M!D' + band_name + '!N-5log h' $
                  ELSE $
                     xtitle = 'M-5log h'
              ENDELSE
          ENDIF

          <span class="comments">;; No xrange/yrange set</span>
          IF n_elements(xrange) LE 1 THEN $
             xrange = ajs_lf_plot_xrange(bincentres=bincentres, $
                                         loglum=loglum, schechter=schechter, $
                                         double_schechter=double_schechter)
          IF n_elements(yrange) LE 1 THEN $
             yrange = ajs_lf_plot_yrange(phi=phi, input_logphi=input_logphi, $
                                         plot_logphi=plot_logphi, $
                                         schechter=schechter, $
                                         double_schechter=double_schechter)

          <span class="comments">;; ylog if not plot_logphi</span>
          IF n_elements(ylog) EQ 0 AND NOT keyword_set(plot_logphi) THEN $
             ylog = 1

          <span class="comments">;; Set /xstyle & /ystyle by default</span>
          IF n_elements(xstyle) EQ 0 THEN $
             xstyle=1
          IF n_elements(ystyle) EQ 0 THEN $
             ystyle=1

          <span class="comments">;; Plot empty axes</span>
          plot,[0],[1], xrange=xrange, yrange=yrange, /nodata, $
               title=title, ytitle=ytitle, xtitle=xtitle, ylog=ylog, $
               xstyle=xstyle, ystyle=ystyle, _STRICT_EXTRA=e
      ENDIF
      plot_logphi = 1 - !y.type

      <span class="comments">;; Define filled circle (IDL Help): psym=8</span>
      <span class="comments">;; Obselete: now uses D. Fanning's symcat routine</span>
<span class="comments">;;       A = FINDGEN(17) * (!PI * 2 / 16.)  </span>
<span class="comments">;;       USERSYM, COS(A), SIN(A), /FILL  </span>

      <span class="comments">;; Plot data points?</span>
      IF n_elements(phi) GT 0 THEN BEGIN 
          <span class="comments">;; Error bars</span>
          IF n_elements(err_phi) GT 0 THEN BEGIN
              neg_err_phi = err_phi
              pos_err_phi = err_phi
          ENDIF
          IF n_elements(neg_err_phi) GT 0 THEN BEGIN 
              phi_err_max = phi + pos_err_phi
              phi_err_min = phi - neg_err_phi
              IF NOT keyword_set(input_logphi) THEN BEGIN 
                  <span class="comments">;; Infinite plot range?</span>
                  too_small = where(phi_err_min LE 0)
                  IF too_small[0] NE -1 THEN $
                     phi_err_min[too_small] = 1e-30 <span class="comments">; log(phi) > 0</span>
              ENDIF
              IF keyword_set(input_logphi) $
                 AND NOT keyword_set(plot_logphi) THEN BEGIN
                  phi_err_max = 10. ^ phi_err_max
                  phi_err_min = 10. ^ phi_err_min                 
              ENDIF ELSE IF NOT keyword_set(input_logphi) $
                 AND keyword_set(plot_logphi) THEN BEGIN
                  phi_err_max = alog10(phi_err_max)
                  phi_err_min = alog10(phi_err_min)
              ENDIF
          ENDIF

          <span class="comments">;; log(phi) ? (NB don't change phi itself!)</span>
          IF keyword_set(input_logphi) $
             AND NOT keyword_set(plot_logphi) THEN $
                phi_plot = 10. ^ phi $
          ELSE IF NOT keyword_set(input_logphi) $
             AND keyword_set(plot_logphi) THEN $
                phi_plot = alog10(phi) $
          ELSE $
             phi_plot = phi

          <span class="comments">;; Plot the data</span>
          IF n_elements(neg_err_phi) GT 0 THEN BEGIN
              <span class="comments">;; With error bars</span>
              IF n_elements(lower_limit_where) GT 0 THEN BEGIN
                  <span class="comments">;; ... and mark out bins which are lower limits</span>
                  all_indices = indgen(n_elements(phi_plot))
                  not_lower_limit_bool = intarr(n_elements(phi_plot)) + 1
                  not_lower_limit_bool[lower_limit_where] = 0
                  not_lower_limit_where = $
                     all_indices[where(not_lower_limit_bool)]
                  oploterror, bincentres[not_lower_limit_where], $
                              phi_plot[not_lower_limit_where], $
                              phi_plot[not_lower_limit_where] $
                              - phi_err_min[not_lower_limit_where], $
                              /lobar, psym=psym_use, $
                              color=color, errcolor=color, _STRICT_EXTRA=e
                  oploterror, bincentres[not_lower_limit_where], $
                              phi_plot[not_lower_limit_where], $
                              phi_err_max[not_lower_limit_where] $
                              - phi_plot[not_lower_limit_where], $
                              /hibar, psym=psym_use, $
                              color=color, errcolor=color, _STRICT_EXTRA=e
                  <span class="comments">;; Open circles?</span>
                  IF n_elements(psym) GT 0 THEN $
                     IF abs(psym) EQ 16 THEN $
                        psym_use = symcat(9 * abs(psym) / 16, $
                                          thick=symcat_thick)
                  oploterror, bincentres[lower_limit_where], $
                              phi_plot[lower_limit_where], $
                              phi_plot[lower_limit_where] $
                              - phi_err_min[lower_limit_where], $
                              /lobar, psym=psym_use, $
                              color=color, errcolor=color, _STRICT_EXTRA=e
                  oploterror, bincentres[lower_limit_where], $
                              phi_plot[lower_limit_where], $
                              phi_err_max[lower_limit_where] $
                              - phi_plot[lower_limit_where], $
                              /hibar, psym=psym_use, /nohat, $
                              color=color, errcolor=color, _STRICT_EXTRA=e
                  <span class="comments">;; Define arrowhead</span>
                  usersym, [-1, 0, 1], [-1, 0, -1]
                  <span class="comments">;; Plot arrows for lower limits</span>
                  oplot, bincentres[lower_limit_where], $
                         phi_err_max[lower_limit_where], psym=8, color=color
                  <span class="comments">;; Restore psym</span>
                  IF psym_use EQ 8 THEN $
                     IF psym EQ 9 OR psym GT 10 THEN $
                        psym_use = symcat(psym, thick=symcat_thick)
              ENDIF ELSE BEGIN
                  <span class="comments">;; Nothing special for lower-limit bins</span>
                  oploterror, bincentres, phi_plot, $
                              phi_plot - phi_err_min, $
                              /lobar, psym=psym_use, $
                              color=color, errcolor=color, _STRICT_EXTRA=e
                  oploterror, bincentres, phi_plot, $
                              phi_err_max - phi_plot, $
                              /hibar, psym=psym_use, $
                              color=color, errcolor=color, _STRICT_EXTRA=e
              ENDELSE
          ENDIF ELSE BEGIN
              <span class="comments">;; Without error bars</span>
              oplot, bincentres, phi_plot, $
                     psym=psym_use, $
                     color=color, _STRICT_EXTRA=e
          ENDELSE
      ENDIF

      <span class="comments">;; Calcluate Schechter function (if not done with LF calculation above)?</span>
      IF (n_elements(schechter) LE 1 $
          AND (arg_present(schechter) $
               OR keyword_set(schechter))) THEN BEGIN
          <span class="comments">;; Calculate best-fitting Schechter function</span>
          schechter = ajs_schechter_fit(bincentres, phi, err_phi, $
                                        cov_mat=cov_mat, range=sch_range)
      ENDIF

      <span class="comments">;; Calcluate double Schechter function (if not done above)?</span>
      IF (n_elements(double_schechter) LE 1 $
          AND (arg_present(double_schechter) $
               OR keyword_set(double_schechter))) THEN BEGIN
          <span class="comments">;; Calculate best-fitting double Schechter function</span>
          double_schechter = $
             ajs_double_schechter_fit(bincentres, phi, err_phi, $
                                      cov_mat=double_cov_mat, range=sch_range)
      ENDIF

      <span class="comments">;; Plot Schechter function?</span>
      IF n_elements(schechter) GT 0 THEN BEGIN
          IF debug GE 1 THEN message, 'Plotting Schechter function', /inf
          mstar = schechter[0]
          alpha = schechter[1]
          IF keyword_set(input_logphi) THEN $ 
             phistar = 10. ^ schechter[2] $
          ELSE $
             phistar = schechter[2]

          IF n_elements(xrange) GT 0 THEN $ 
             m = ajs_linspace(min(xrange), max(xrange), 101) $
          ELSE $
             m = ajs_linspace(mstar + 20, mstar - 10, 501)
          phi_sch = ajs_schechter(m, [mstar, $
                                      alpha, $
                                      phistar], loglum=loglum)

          IF keyword_set(plot_logphi) THEN $
             phi_sch = alog10(phi_sch)
          
          oplot, m, phi_sch, color=color, _STRICT_EXTRA=e
      ENDIF

      <span class="comments">;; Plot double Schechter function?</span>
      IF n_elements(double_schechter) GT 0 THEN BEGIN
          IF debug GE 1 THEN message, 'Plotting double Schechter fn', /inf
          mstar = double_schechter[0]
          alpha_1 = double_schechter[1]
          alpha_2 = double_schechter[3]
          IF keyword_set(input_logphi) THEN BEGIN
              phistar_1 = 10. ^ double_schechter[2]
              phistar_2 = 10. ^ double_schechter[4]
          ENDIF ELSE BEGIN
              phistar_1 = double_schechter[2]
              phistar_2 = double_schechter[4]
          ENDELSE
              
          IF n_elements(xrange) GT 0 THEN $ 
             m = ajs_linspace(min(xrange), max(xrange), 101) $
          ELSE $
             m = ajs_linspace(mstar + 20, mstar - 10, 501)
          phi_double_sch = ajs_double_schechter( $
                           m, [mstar, $
                               alpha_1, phistar_1, alpha_2, $
                               phistar_2], loglum=loglum)
          
          IF keyword_set(plot_logphi) THEN $
             phi_double_sch = alog10(phi_double_sch)
          
          oplot, m, phi_double_sch, color=color, _STRICT_EXTRA=e
      ENDIF

      <span class="comments">;; Add legend?</span>
      ajs_lf_plot_legend, legend_text=legend_text, legend_pos=legend_pos, $
                          arg_legend_pos=arg_present(legend_pos), $
<span class="comments">;;                           xrange=xrange, yrange=yrange, loglum=loglum, $</span>
<span class="comments">;;                           plot_logphi=plot_logphi, $</span>
                          schechter=schechter, $
                          double_schechter=double_schechter, $
                          color=color, psym=psym_use, $
                          _EXTRA=e
  ENDIF

  ajs_plot_stop, plotfile=plotfile, show_plot=show_plot, open=open, close=close
      
  RETURN
END
</code>
    </div>
  </body>
</html>